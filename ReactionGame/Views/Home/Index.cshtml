@{
    ViewBag.Title = "Reaktionstisspelet";
}

<div style="width:700px; margin:0 auto;background-color:#fe96f8;text-align:center;padding:40px;	border-radius: 25px;" >
    <h2>Du är nu med i Reaktionstidsspelet :)</h2>
    <input type="text" id="chatMessage" /> <input type="button" id="chatButton" onclick="chatMessageButtonClicked();" value="Skicka meddelande"/>
    <input type="hidden" id="playerName" />
    <br />
    <br />
    <div id="players"></div>
    <br />
    <div id="messages"></div>
    <div id="clickTarget" style="width:200px;height:100px;text-align: center; vertical-align: middle;line-height: 100px;font-size:20px;font-weight:bold;cursor:pointer;margin:0 auto;border-radius: 25px;" onclick="targetClicked()">

    </div>
</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.0.3.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            var $connection = $.connection;
            var $gameHub = $connection.reactionGameHub;

            $gameHub.client.updateListOfPlayers = function (players) { updateListOfPlayers(players, $gameHub.connection.id); };
            $gameHub.client.updateGameStatus = function (status) { updateGameStatus(status); };
            $gameHub.client.showFastestClicker = function (player, diff) { showFastestClicker(player, $gameHub.connection.id, diff); };
            $gameHub.client.showTooTriggerHappy = function (player) { showTooTriggerHappy(player, $gameHub.connection.id); };
            $gameHub.client.playerJoined = function (player) { playerJoined(player); };
            $gameHub.client.playerDisconnected = function (player) { playerDisconnected(player); };
            $gameHub.client.showChatMessage = function (message) { showChatMessage(message); };

            // Get the user name and store it to prepend to messages.
            $('#playerName').val(prompt('Enter your name:', ''));
            // Start the connection.
            $connection.hub.start().done(function () {
                $gameHub.server.join($('#playerName').val());
            });

            $('#chatMessage').keyup(function (event) {
                if (event.keyCode == 13) {
                    $('#chatButton').click();
                };
            });
        });

        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

        function updateListOfPlayers(players, connectionId) {
            var $listOfPlayers = $('#players');
            $listOfPlayers.empty();
            $.each(players, function (index, player) {
                var playerInfo = index+1 + '. ' + htmlEncode(player.Name) + ': ' + player.Points + ' poäng. Snabbaste tid: ' + player.FastestReactionTime + 'ms';
                playerInfo = player.Id == connectionId ? '<b>' + playerInfo + '</b>' : playerInfo;
                $listOfPlayers.append('<p>' + playerInfo + '</p>');
            });
        }

        function updateGameStatus(status){
            var color;
            var text;
            switch (status) {
                case "GetReady":
                    color = '#ffff00';
                    text = 'Var beredd!';
                    break;
                case "Go":
                    color = '#00ff00';
                    text = 'KLICKA!!!';
                    break;
                case "Stop":
                    color = '#ff0000';
                    text = 'Stopp!';
                    break;
                default:
                    color = '#000000';
                    break;
            }
            var $clicktarget = $('#clickTarget');
            $clicktarget.css('background-color', color);
            $clicktarget.text(text);
        }

        function showFastestClicker(player, connectionId, diff) {
            var message = 'Snabbast var ' + (player.Id == connectionId ? 'DU!!! +1 poäng.' : player.Name) + ' Reaktionstid: ' + diff + 'ms!';
            showMessage(message, '00ff00', 3000);
        }

        function showTooTriggerHappy(player, connectionId) {
            var message = (player.Id == connectionId ? 'Du' : player.Name) + ' tjuvstartade! -1 poäng.';
            showMessage(message, 'ff0000', 2000);
        }

        function playerDisconnected(player) {
            var message = player.Name + ' har lämnat spelet.';
            showMessage(message, 'cccccc', 8000);
        }

        function playerJoined(player) {
            var message = player.Name + ' är med i spelet!';
            showMessage(message, 'cccccc', 8000);
        }

        function showChatMessage(message) {
            var encoded = htmlEncode(message);
            showMessage(encoded, '9999ff', 15000);
        }

        function showMessage(message, color, fadeOutDuration) {
            var $p = $('<b><p style=\'background-color:#' + color + '\'>' + message + '</p></b>');
            $('#messages').append($p);
            $p.fadeIn(500).fadeOut(fadeOutDuration);
        }

        function targetClicked() {
            $.connection.reactionGameHub.server.targetClicked();
        }

        function chatMessageButtonClicked() {            
            $.connection.reactionGameHub.server.chatMessageSent($('#chatMessage').val());
            $('#chatMessage').val('');
        }
    </script>
}